<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🧠 My GitHub Thoughts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
  <style>
    iframe {
      width: 100%;
      max-width: 720px;
      height: 405px;
      margin-top: 1rem;
    }
    .markdown-body img {
      cursor: pointer;
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-4xl font-bold mb-6 flex items-center gap-3">🧠 My GitHub Thoughts</h1>

    <div class="mb-6 flex flex-wrap gap-4">
      <input id="search" type="text" placeholder="搜索关键词..."
        class="w-full p-3 border rounded shadow-sm text-lg" />
      <select id="tagFilter" class="p-2 rounded border">
        <option value="all">所有标签</option>
      </select>
    </div>

    <div id="posts" class="space-y-10"></div>

    <div class="mt-8 flex justify-center gap-4 text-blue-500">
      <button id="prevBtn" class="hover:underline">上一页</button>
      <button id="nextBtn" class="hover:underline">下一页</button>
    </div>
  </div>

<script>
const POSTS_PER_PAGE = 5;
let allPosts = [], currentPage = 1;

function renderMarkdown(body) {
  return marked.parse(body).replace(
    /<img src=\"(.*?)\"/g,
    (match, src) => `<a href="${src}" class="glightbox"><img src="${src}"`
  ).replace(
    /https:\/\/www\.youtube\.com\/watch\?v=([\w-]+)/g,
    (match, id) => `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`
  );
}

function renderPosts() {
  const tag = document.getElementById('tagFilter').value;
  const query = document.getElementById('search').value.toLowerCase();
  const filtered = allPosts.filter(p => {
    const content = (p.title + p.body).toLowerCase();
    const matchQuery = content.includes(query);
    const matchTag = tag === 'all' || (p.tags && p.tags.includes(tag));
    return matchQuery && matchTag;
  });
  const start = (currentPage - 1) * POSTS_PER_PAGE;
  const visible = filtered.slice(start, start + POSTS_PER_PAGE);

  const container = document.getElementById('posts');
  container.innerHTML = '';

  visible.forEach(post => {
    const el = document.createElement('div');
    el.innerHTML = `
      <h2 class="text-2xl font-bold text-blue-600 mb-2">
        <a href="${post.html_url}" target="_blank">${post.title}</a>
      </h2>
      <div class="markdown-body prose max-w-full">${renderMarkdown(post.body)}</div>
      <div class="text-sm text-gray-500 mt-2">🕒 ${new Date(post.created_at).toLocaleString()}</div>
      <div class="text-xs text-gray-400">${post.tags?.join(', ') || ''}</div>
    `;
    container.appendChild(el);
  });
  GLightbox({ selector: '.glightbox' });
}

fetch('data.json')
  .then(res => res.json())
  .then(data => {
    allPosts = data;
    const tags = new Set();
    data.forEach(p => p.tags?.forEach(t => tags.add(t)));
    tags.forEach(tag => {
      const opt = document.createElement('option');
      opt.value = tag;
      opt.textContent = tag;
      document.getElementById('tagFilter').appendChild(opt);
    });
    renderPosts();
  })
  .catch(err => {
    document.getElementById('posts').innerHTML = `<div class="text-red-500">⚠️ Failed to load data.json: ${err.message}</div>`;
  });

document.getElementById('search').addEventListener('input', () => {
  currentPage = 1;
  renderPosts();
});

document.getElementById('tagFilter').addEventListener('change', () => {
  currentPage = 1;
  renderPosts();
});

document.getElementById('prevBtn').onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    renderPosts();
  }
};

document.getElementById('nextBtn').onclick = () => {
  const tag = document.getElementById('tagFilter').value;
  const query = document.getElementById('search').value.toLowerCase();
  const total = allPosts.filter(p => {
    const content = (p.title + p.body).toLowerCase();
    return content.includes(query) && (tag === 'all' || (p.tags && p.tags.includes(tag)));
  }).length;
  if (currentPage * POSTS_PER_PAGE < total) {
    currentPage++;
    renderPosts();
  }
};
</script>
</body>
</html>
